<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroDrive DMS Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/firebase@10.7.1/dist/index.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Import the NeuroDrive Dashboard component
        const { useState, useEffect, useMemo, useRef } = React;
        const { initializeApp, getApps } = firebase;
        const { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } = firebase.auth;
        const { getFirestore, doc, onSnapshot, setDoc, serverTimestamp } = firebase.firestore;

        // Default config
        const DEFAULT_RISK_WEIGHTS = {
            drowsiness: 0.25,
            distraction: 0.30,
            headPose: 0.25,
            unauthorizedObjects: 0.20,
        };

        const DEFAULT_THRESHOLDS = {
            eyeClosureTimeSeconds: 2.0,
            distractionDetectedThreshold: 0.5,
            headPoseDegreesThreshold: 15,
            unauthorizedObjectsThreshold: 1,
            speedLimitKmh: 80,
        };

        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        function computeStatusText(score) {
            if (score < 30) return 'Critical Risk';
            if (score < 50) return 'High Risk';
            if (score < 70) return 'Elevated Risk';
            if (score < 85) return 'Low Risk';
            return 'Alert';
        }

        function scoreToColor(score) {
            if (score < 30) return 'text-red-500';
            if (score < 70) return 'text-yellow-500';
            return 'text-green-500';
        }

        function ringColor(score) {
            if (score < 30) return 'stroke-red-500';
            if (score < 70) return 'stroke-yellow-400';
            return 'stroke-green-500';
        }

        function metricStatus(ok) {
            return ok ? { text: 'OK', color: 'text-green-600', bg: 'bg-green-50' } : { text: 'ALERT', color: 'text-red-600', bg: 'bg-red-50' };
        }

        function seededRandom(seedRef) {
            let x = seedRef.current || 123456789;
            x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
            seedRef.current = x >>> 0;
            return (seedRef.current % 10000) / 10000;
        }

        function Gauge({ value }) {
            const radius = 80;
            const stroke = 14;
            const normalizedRadius = radius - stroke;
            const circumference = normalizedRadius * 2 * Math.PI;
            const clamped = clamp(value, 0, 100);
            const strokeDashoffset = circumference - (clamped / 100) * circumference;
            const ringCls = ringColor(clamped);
            return React.createElement('svg', {
                height: radius * 2,
                width: radius * 2,
                className: "overflow-visible"
            },
                React.createElement('circle', {
                    stroke: "#e5e7eb",
                    fill: "transparent",
                    strokeWidth: stroke,
                    r: normalizedRadius,
                    cx: radius,
                    cy: radius
                }),
                React.createElement('circle', {
                    strokeLinecap: "round",
                    className: ringCls,
                    fill: "transparent",
                    strokeWidth: stroke,
                    r: normalizedRadius,
                    cx: radius,
                    cy: radius,
                    style: { strokeDasharray: `${circumference} ${circumference}`, strokeDashoffset },
                    transform: `rotate(-90 ${radius} ${radius})`
                }),
                React.createElement('text', {
                    x: "50%",
                    y: "50%",
                    dominantBaseline: "middle",
                    textAnchor: "middle",
                    className: `font-semibold text-3xl ${scoreToColor(clamped)}`
                }, Math.round(clamped))
            );
        }

        function MetricCard({ title, value, threshold, ok, unit }) {
            const st = metricStatus(ok);
            return React.createElement('div', {
                className: `rounded-xl border border-gray-200 p-4 ${st.bg}`
            },
                React.createElement('div', {
                    className: "flex items-center justify-between"
                },
                    React.createElement('div', {
                        className: "text-gray-600 text-sm font-medium"
                    }, title),
                    React.createElement('div', {
                        className: `text-xs px-2 py-0.5 rounded-full ${ok ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`
                    }, st.text)
                ),
                React.createElement('div', {
                    className: "mt-3 flex items-end gap-2"
                },
                    React.createElement('div', {
                        className: "text-2xl font-semibold text-gray-900"
                    }, `${value}${unit ? ` ${unit}` : ''}`)
                ),
                React.createElement('div', {
                    className: "mt-1 text-xs text-gray-500"
                }, `Threshold: ${threshold}${unit ? ` ${unit}` : ''}`)
            );
        }

        function EventLog({ events }) {
            return React.createElement('div', {
                className: "h-56 overflow-y-auto rounded-xl border border-gray-200 bg-white"
            },
                React.createElement('div', {
                    className: "sticky top-0 bg-gray-50 px-4 py-2 text-xs font-semibold text-gray-600 border-b"
                }, "Real-Time Alerts & Events"),
                React.createElement('ul', {
                    className: "divide-y"
                },
                    events.length === 0 ? 
                        React.createElement('li', {
                            className: "px-4 py-3 text-sm text-gray-500"
                        }, "No events yet.") :
                        events.map((e, idx) => 
                            React.createElement('li', {
                                key: idx,
                                className: "px-4 py-3 text-sm"
                            },
                                React.createElement('div', {
                                    className: "flex items-center justify-between"
                                },
                                    React.createElement('span', {
                                        className: "font-medium text-gray-800"
                                    }, e.type),
                                    React.createElement('span', {
                                        className: "text-xs text-gray-500"
                                    }, new Date(e.ts).toLocaleTimeString())
                                ),
                                e.detail ? React.createElement('div', {
                                    className: "text-gray-600 text-xs mt-0.5"
                                }, e.detail) : null
                            )
                        )
                )
            );
        }

        function NeuroDriveDashboard() {
            const [riskScore, setRiskScore] = useState(85);
            const [statusText, setStatusText] = useState('Low Risk');
            const [metrics, setMetrics] = useState({
                drowsiness: { value: 0.6, threshold: 2.0, unit: 's', ok: true },
                distraction: { value: 0, threshold: 0.5, unit: '', ok: true },
                headPose: { value: 5.0, threshold: 15, unit: '°', ok: true },
                unauthorizedObjects: { value: 0, threshold: 1, unit: '', ok: true },
                speed: { value: 65, threshold: 80, unit: 'km/h', ok: true },
            });
            const [events, setEvents] = useState([]);

            // Simulation controls
            const [eyeClosureRatio, setEyeClosureRatio] = useState(0.2);
            const [phoneUsage, setPhoneUsage] = useState(false);
            const [speed, setSpeed] = useState(65);

            const rngSeed = useRef(987654321);

            // Simulate backend calls
            useEffect(() => {
                const interval = setInterval(async () => {
                    try {
                        const response = await fetch('http://localhost:8000/api/v1/infer', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                eyeClosureRatio: eyeClosureRatio,
                                phoneUsage: phoneUsage,
                                speed: speed
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            setRiskScore(result.riskScore);
                            setStatusText(result.statusText);
                            if (result.metrics) {
                                setMetrics(result.metrics);
                            }
                            
                            // Add new events if risk is high
                            if (result.riskScore < 70) {
                                const newEvent = {
                                    type: 'Risk Alert',
                                    detail: `Risk score: ${result.riskScore}`,
                                    ts: Date.now()
                                };
                                setEvents(prev => [newEvent, ...prev.slice(0, 99)]);
                            }
                        }
                    } catch (err) {
                        console.warn('Backend call failed:', err);
                    }
                }, 2000);

                return () => clearInterval(interval);
            }, [eyeClosureRatio, phoneUsage, speed]);

            return React.createElement('div', {
                className: "min-h-screen w-full bg-gray-50"
            },
                React.createElement('div', {
                    className: "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"
                },
                    // Header
                    React.createElement('header', {
                        className: "flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
                    },
                        React.createElement('div', null,
                            React.createElement('h1', {
                                className: "text-2xl font-bold text-gray-900"
                            }, "NeuroDrive DMS Dashboard"),
                            React.createElement('p', {
                                className: "text-sm text-gray-600"
                            }, "FastAPI Backend Connected")
                        ),
                        React.createElement('div', {
                            className: "flex items-center gap-3"
                        },
                            React.createElement('span', {
                                className: `text-sm font-semibold ${scoreToColor(riskScore)}`
                            }, statusText)
                        )
                    ),

                    // Main content
                    React.createElement('div', {
                        className: "mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6"
                    },
                        // Risk Score Gauge
                        React.createElement('div', {
                            className: "col-span-1 lg:col-span-1"
                        },
                            React.createElement('div', {
                                className: "rounded-2xl bg-white border border-gray-200 p-6 flex flex-col items-center"
                            },
                                React.createElement('div', {
                                    className: "text-sm font-medium text-gray-600 mb-2"
                                }, "Unified Risk Score"),
                                React.createElement(Gauge, { value: riskScore }),
                                React.createElement('div', {
                                    className: "mt-4 text-sm text-gray-500"
                                }, "Green &gt; 70 · Yellow 30–70 · Red &lt; 30")
                            )
                        ),

                        // Metrics
                        React.createElement('div', {
                            className: "col-span-1 lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6"
                        },
                            React.createElement(MetricCard, {
                                title: "Drowsiness",
                                value: metrics.drowsiness.value,
                                threshold: metrics.drowsiness.threshold,
                                ok: metrics.drowsiness.ok,
                                unit: metrics.drowsiness.unit
                            }),
                            React.createElement(MetricCard, {
                                title: "Distraction",
                                value: metrics.distraction.value,
                                threshold: metrics.distraction.threshold,
                                ok: metrics.distraction.ok,
                                unit: metrics.distraction.unit
                            }),
                            React.createElement(MetricCard, {
                                title: "Head Pose",
                                value: metrics.headPose.value,
                                threshold: metrics.headPose.threshold,
                                ok: metrics.headPose.ok,
                                unit: metrics.headPose.unit
                            }),
                            React.createElement(MetricCard, {
                                title: "Speed",
                                value: metrics.speed.value,
                                threshold: metrics.speed.threshold,
                                ok: metrics.speed.ok,
                                unit: metrics.speed.unit
                            })
                        )
                    ),

                    // Controls and Events
                    React.createElement('div', {
                        className: "mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6"
                    },
                        React.createElement('div', {
                            className: "col-span-1 lg:col-span-2"
                        },
                            React.createElement(EventLog, { events: events })
                        ),
                        React.createElement('div', {
                            className: "col-span-1"
                        },
                            React.createElement('div', {
                                className: "rounded-2xl bg-white border border-gray-200 p-6"
                            },
                                React.createElement('div', {
                                    className: "text-sm font-semibold text-gray-700 mb-4"
                                }, "Simulation Controls"),
                                React.createElement('div', {
                                    className: "space-y-5"
                                },
                                    React.createElement('div', null,
                                        React.createElement('div', {
                                            className: "flex items-center justify-between text-sm text-gray-700"
                                        },
                                            React.createElement('label', {
                                                className: "font-medium"
                                            }, "Eye Closure Ratio"),
                                            React.createElement('span', {
                                                className: "font-mono"
                                            }, eyeClosureRatio.toFixed(2))
                                        ),
                                        React.createElement('input', {
                                            type: "range",
                                            min: 0,
                                            max: 1,
                                            step: 0.01,
                                            value: eyeClosureRatio,
                                            onChange: (e) => setEyeClosureRatio(parseFloat(e.target.value)),
                                            className: "w-full mt-2"
                                        })
                                    ),
                                    React.createElement('div', {
                                        className: "flex items-center justify-between"
                                    },
                                        React.createElement('div', null,
                                            React.createElement('div', {
                                                className: "text-sm font-medium text-gray-700"
                                            }, "Phone Usage Detected"),
                                            React.createElement('div', {
                                                className: "text-xs text-gray-500"
                                            }, "Toggles distraction")
                                        ),
                                        React.createElement('button', {
                                            onClick: () => setPhoneUsage(v => !v),
                                            className: `relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${phoneUsage ? 'bg-red-500' : 'bg-gray-300'}`
                                        },
                                            React.createElement('span', {
                                                className: `inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${phoneUsage ? 'translate-x-6' : 'translate-x-1'}`
                                            })
                                        )
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('div', {
                                            className: "flex items-center justify-between text-sm text-gray-700"
                                        },
                                            React.createElement('label', {
                                                className: "font-medium"
                                            }, "Speed (km/h)"),
                                            React.createElement('span', {
                                                className: "font-mono"
                                            }, speed)
                                        ),
                                        React.createElement('input', {
                                            type: "number",
                                            min: 0,
                                            max: 200,
                                            step: 1,
                                            value: speed,
                                            onChange: (e) => setSpeed(parseInt(e.target.value || '0', 10)),
                                            className: "mt-2 w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                        }),
                                        React.createElement('div', {
                                            className: "text-xs text-gray-500 mt-1"
                                        }, "Limit: 80 km/h")
                                    )
                                )
                            )
                        )
                    )
                )
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(NeuroDriveDashboard));
    </script>
</body>
</html>
